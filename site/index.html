<!doctype html>
<html class="theme-dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>The web site of opbb-test-site</title>
        <!-- image-js package can be found here https://github.com/image-js/image-js -->
        <script src="packages/image-js.min.0.36.0.js"></script>
        <!-- FileSaver.js package can be found here https://github.com/eligrey/FileSaver.js -->
        <script src="packages/FileSaver.min.js"></script>
        <!-- jszip package can be found here https://github.com/Stuk/jszip -->
        <script src="packages/jszip.min.js"></script>

        <!-- <link rel="stylesheet" href="style.css" /> -->
        <link rel="stylesheet" href="bulma-style.css" />
    </head>
    <body>
        <section class="section">
            <div class="container">
                <p class="title has-text-centered">image-to-text</p>
            </div>
        </section>
        <section class="section">
            <input type="range" min="1" max="50" value="10" class="slider" />
        </section>
        <section id="content-container" class="section">
            <nav id="control-buttons" class="columns">
                <div class="column is-half">
                    <input
                        id="image-selector"
                        type="file"
                        accept=".png,.jpg,.jpeg,.tiff,.tif,.mov,.mp4,.m4a"
                        style="display: none"
                    />
                    <label
                        for="image-selector"
                        class="button is-fullwidth is-large"
                        ><div>Select Image</div></label
                    >
                </div>
                <div class="column is-half">
                    <button
                        class="button is-fullwidth is-large"
                        id="save-button"
                    >
                        Save
                    </button>
                </div>
            </nav>
            <!-- <div class="container">
                <p id="loading-text" class="has-text-centered">
                    <span id="loading-spinner"></span>
                </p>
            </div> -->
            <div class="columns" style="min-height: 50vh">
                <div class="column is-half">
                    <img id="media" />
                </div>
                <div class="column is-half">
                    <p id="text-image" class="ascii-image"></p>
                </div>
            </div>
        </section>
        <footer class="footer has-text-centered is-italic">Footer</footer>

        <script src="image-to-text.js"></script>
        <script type="module">
            import { FFmpeg } from "/packages/ffmpeg/ffmpeg/package/dist/esm/index.js";
            import { fetchFile } from "/packages/ffmpeg/util/package/dist/esm/index.js";
            let ffmpeg = null;

            const imageSelector = document.getElementById("image-selector");
            imageSelector.onchange = loadMedia;
            const saveButton = document.getElementById("save-button");
            saveButton.disabled = true;
            saveButton.onclick = saveFile;
            const mediaEl = document.getElementById("media");
            const textImageEl = document.getElementById("text-image");

            let textImages = undefined;

            function saveFile() {
                const zip = new JSZip();
                zip.file("plainTextImage.txt", plainTextImage);
                zip.file("htmlImage.txt", htmlImage);
                zip.generateAsync({ type: "blob" }).then(function (content) {
                    saveAs(content, "textImages.zip");
                });
            }

            async function loadMedia() {
                const mediaFile = imageSelector.files[0];
                if (mediaFile.type.includes("video")) {
                    loadVideo(mediaFile);
                } else if (mediaFile.type.includes("image")) {
                    loadImage(mediaFile);
                } else {
                    console.error(
                        `Incompatible media type (${mediaFile.type}). Must be either image or video.`,
                    );
                }
            }

            async function loadVideo(videoFile) {
                console.log("loading video");
            }

            async function loadImage(imageFile) {
                saveButton.disabled = true;
                mediaEl.src = undefined;
                textImages = undefined;

                const reader = new FileReader();
                reader.onloadend = async () => {
                    let image = await IJS.Image.load(reader.result);
                    mediaEl.src = image.toDataURL();
                    textImages = imageToText(image);
                    textImageEl.innerHTML = textImages.htmlImage;
                    saveButton.disabled = false;
                };
                console.log(imageFile);
                reader.readAsArrayBuffer(imageFile);
            }

            // // === LOADING SPINNER ===
            // const spinnerElement = document.getElementById("loading-spinner");
            // if (spinnerElement === null)
            //     console.error(
            //         "Loading Spinner code is present, but could not find spinner element.",
            //     );

            // // Animation Parameters
            // const spinnerSpeed = 125; // How long each frame is held in ms
            // const animChars = ["-", "\\", "|", "/"]; // Animation frames
            // let curCharIndex = 0; // Starting frame

            // // Animation
            // spinnerElement.innerHTML = animChars[curCharIndex];
            // let spinnerIntervalId;
            // function startLoadingSpinner() {
            //     stopLoadingSpinner();
            //     spinnerIntervalId = setInterval(() => {
            //         curCharIndex = (curCharIndex + 1) % 4;
            //         spinnerElement.innerHTML = animChars[curCharIndex];
            //     }, spinnerSpeed);
            // }

            // function stopLoadingSpinner() {
            //     if (spinnerIntervalId !== undefined) {
            //         clearInterval(spinnerIntervalId);
            //         spinnerIntervalId = undefined;
            //     }
            // }
            // startLoadingSpinner();
        </script>
    </body>
</html>

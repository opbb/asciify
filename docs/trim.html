<html>
    <head>
        <link rel="stylesheet" href="bulma-style.css" />
    </head>
    <body>
        <h3>
            Upload a mp4 (x264) video and trim its first 1 seconds and play!
        </h3>
        <input type="file" id="uploader" />
        <p id="message"></p>
        <div class="columns">
            <img id="output-image-1" class="column is-one-third" />
            <img id="output-image-2" class="column is-one-third" />
            <img id="output-image-3" class="column is-one-third" />
        </div>
        <script type="module">
            import { FFmpeg } from "/image-to-text/packages/ffmpeg/ffmpeg/package/dist/esm/index.js";
            import { fetchFile } from "/image-to-text/packages/ffmpeg/util/package/dist/esm/index.js";
            let ffmpeg = null;

            async function loadFFmpeg() {
                const message = document.getElementById("message");
                if (ffmpeg === null) {
                    ffmpeg = new FFmpeg();
                    ffmpeg.on("log", ({ message }) => {
                        console.log(message);
                    });
                    ffmpeg.on("progress", ({ progress }) => {
                        message.innerHTML = `${progress * 100} %`;
                    });
                    await ffmpeg.load({
                        coreURL:
                            "/image-to-text/packages/ffmpeg/core/package/dist/esm/ffmpeg-core.js",
                    });
                }
            }

            const trim = async ({ target: { files } }) => {
                loadFFmpeg();
                const { name } = files[0];
                await ffmpeg.writeFile(name, await fetchFile(files[0]));
                message.innerHTML = "Start trimming";
                await ffmpeg.createDir("video");
                await ffmpeg.exec([
                    "-i",
                    name,
                    "-vf",
                    "fps=30",
                    "video/%06d.jpg",
                ]);
                message.innerHTML = "Complete trimming";

                let data = await ffmpeg.readFile("video/000001.jpg");
                let image = document.getElementById("output-image-1");
                image.src = URL.createObjectURL(
                    new Blob([data.buffer], { type: "image/jpeg" }),
                );
                data = await ffmpeg.readFile("video/000100.jpg");
                image = document.getElementById("output-image-2");
                image.src = URL.createObjectURL(
                    new Blob([data.buffer], { type: "image/jpeg" }),
                );
                data = await ffmpeg.readFile("video/000200.jpg");
                image = document.getElementById("output-image-3");
                image.src = URL.createObjectURL(
                    new Blob([data.buffer], { type: "image/jpeg" }),
                );
                (await ffmpeg.listDir("video")).forEach((file) => {
                    if (file.name === "." || file.name === "..") {
                        return;
                    }
                    console.log(file.name);
                });
            };
            const elm = document.getElementById("uploader");
            elm.addEventListener("change", trim);
        </script>
    </body>
</html>
